@page "{id:int}"
@model BoticaOnline.Web.Pages.Pedidos.DetalleModel
@{
    // Corrección: Usamos ?. para acceso seguro a propiedades que pueden ser null (Cliente y Prescripcion)
    // Usamos el operador coalescente (??) para mostrar un valor por defecto si es null.
    
    // Verificación de si Pedido existe antes de acceder a .Id
    ViewData["Title"] = Model.Pedido != null ? $"Detalle Pedido #{Model.Pedido.Id}" : "Detalle de Pedido";
    
    string estadoClass = Model.Pedido?.Estado switch
    {
        "Completado" => "text-success",
        "Cancelado" => "text-danger",
        "Enviado" => "text-primary",
        _ => "text-secondary"
    };
}

<h1 class="display-4">Detalle del Pedido <span class="badge bg-warning text-dark">#@Model.Pedido?.Id</span></h1>
<hr />

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

@if (Model.Pedido == null)
{
    <div class="alert alert-danger">Pedido no encontrado.</div>
    return;
}

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">Información General</div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Cliente:</dt>
                    <dd class="col-sm-8">@Model.Pedido.Cliente?.Nombre @Model.Pedido.Cliente?.Apellido</dd>
                    
                    <dt class="col-sm-4">Email / Teléfono:</dt>
                    <dd class="col-sm-8">@Model.Pedido.Cliente?.Email / @Model.Pedido.Cliente?.Telefono</dd>
                    
                    <dt class="col-sm-4">Fecha Pedido:</dt>
                    <dd class="col-sm-8">@Model.Pedido.FechaPedido.ToString("dd/MM/yyyy HH:mm")</dd>
                    
                    <dt class="col-sm-4">Total:</dt>
                    <dd class="col-sm-8 h4 text-success">$@Model.Pedido.Total.ToString("N2")</dd>

                    @* Mostramos la Prescripción si está asociada *@
                    @if (Model.Pedido.PrescripcionId.HasValue)
                    {
                        <dt class="col-sm-4 text-info">Prescripción #:</dt>
                        <dd class="col-sm-8">
                            @Model.Pedido.PrescripcionId 
                            (<a href="@Model.Pedido.Prescripcion?.RutaArchivo" target="_blank" class="text-info">Ver Archivo</a>)
                        </dd>
                    }
                </dl>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-info text-white">Gestión y Estado</div>
            <div class="card-body">
                <p>Estado Actual: <span class="h5 @estadoClass">@Model.Pedido.Estado</span></p>

                <form method="post" asp-page-handler="UpdateStatus" class="d-flex mb-3">
                    <input type="hidden" name="id" value="@Model.Pedido.Id" />
                    
                    <select asp-for="NuevoEstado" 
                        class="form-control me-2" 
                        asp-items="@(new SelectList(Model.EstadosDisponibles))"
                        disabled="@(Model.Pedido.Estado == "Cancelado" || Model.Pedido.Estado == "Completado")">
                    </select>
                    
                    <button type="submit" class="btn btn-warning" 
                        disabled="@(Model.Pedido.Estado == "Cancelado" || Model.Pedido.Estado == "Completado")">
                        Actualizar
                    </button>
                </form>

                @if (Model.Pedido.Estado != "Cancelado" && Model.Pedido.Estado != "Completado")
                {
                    <form method="post" asp-page-handler="Cancel" onsubmit="return confirm('ATENCIÓN: ¿Está seguro de que desea CANCELAR este pedido? Se devolverá el stock al inventario.');">
                        <input type="hidden" name="id" value="@Model.Pedido.Id" />
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="fas fa-times-circle"></i> Cancelar Pedido
                        </button>
                    </form>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">Productos en el Pedido</div>
            <div class="card-body">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* CORRECCIÓN CLAVE: Detalles -> DetallesPedido *@
                        @foreach (var detalle in Model.Pedido.DetallesPedido)
                        {
                            <tr>
                                <td>@detalle.Producto?.Nombre</td>
                                <td>@detalle.Cantidad</td>
                                <td>$@detalle.PrecioUnitario.ToString("N2")</td>
                                <td>$@((detalle.Cantidad * detalle.PrecioUnitario).ToString("N2"))</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">TOTAL FINAL:</th>
                            <th class="h6">$@Model.Pedido.Total.ToString("N2")</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a asp-page="./Listado" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Regresar al Listado</a>
</div>